{% extends 'layouts/base.html' %}
{% load bootstrap_icons %}
{% load static %}


{% block page_content %}
<div class="container mt-4">
  <div class="mb-4">
    <a href="javascript:history.back()" class="btn btn-outline-secondary shadow-sm">← Назад</a>
  </div>

  <!-- Карточка с объявлением -->
  <div class="card shadow">
    <div class="card-header bg-primary text-white">
      <h2 class="card-title mb-0">{{ad.title}}</h2>
    </div>

    <div>
      {% if request.user == ad.owner %}
        Статус: {{ ad.get_status_display }}
      {% endif %}
    </div>

    <p class="mb-0 small"><span class="text-muted me-2">Категория:</span>
      {% if ad.category.parent %}
      {# Ссылка на родителя #}
        <a href="{{ ad.category.parent.get_absolute_url }}" class="text-dark text-decoration-none opacity-75">
          {{ ad.category.parent.name }}
        </a>
        <span class="mx-1 text-muted">/</span>
      {% endif %}

      {# Ссылка на саму категорию объявления #}
      <a href="{{ ad.category.get_absolute_url }}" class="fw-medium text-decoration-none">
        {{ ad.category.name }}
      </a>
    </p>

    <p>Теги: 
    {% for tag in ad.tags.all %}
      <a href="{{ tag.get_absolute_url }}">#{{ tag.name }}</a>{% if not forloop.last %}, {% endif %}
    {% empty %}
      нет тегов
    {% endfor %}
    </p>

    <div class="card-body">
      <!-- Изображение -->
      {% if ad.goods_image %}
      <div class="text-center mb-4">
        <img src="{{ ad.goods_image.url }}" alt="{{ ad.title }}" class="img-fluid rounded" style="max-width: 300px; max-height: 200px">
      </div>
      {% endif %}

      <!-- Описание -->
      <div class="mb-4">
        <h5 class="text-secondary">Описание:</h5>
        <p>{{ad.text}}</p>
      </div>

      <!-- Информация -->
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <strong>Цена:</strong>
            <span class="badge bg-success fs-6 ms-2">
              {% if ad.price is not None %}
              {{ ad.price }} ₽
              {% else %}
              Не указана
              {% endif %}
            </span>
          </div>

          <div class="mb-3">
            <strong>Контакты:</strong>
            <span class="ms-2">
              {% if ad.contacts %}
              {{ ad.contacts }}
              {% else %}
              <span class="text-muted">Не указаны</span>
              {% endif %}
            </span>
          </div>

          <div class="mb-3">
            <strong>Дата публикации:</strong>
            <span class="ms-2 date-field">{{ ad.created_at|date:"c" }}</span>
          </div>
          <div class="mb-3">
            <strong>Дата последнего изменения:</strong>
            <span class="ms-2 date-field">{{ad.updated_at|date:"c"}}</span>
          </div>
          <div>Автор объявления: <a href="{% url 'users:profile' username=ad.owner.username %}">{{ ad.owner }}</a></div>
          <div>{% bs_icon 'eye' %}Количество просмотров: {{ ad.views }}</div>  
        </div>
      </div>
      {% if request.user == ad.owner %}
      <!-- Кнопки БЕЗ ИКОНОК -->
      <div class="mt-4 pt-3 border-top">
        <a href="{% url 'ads:update_ad' ad.id %}" class="btn btn-warning me-2">
          Редактировать
        </a>
        <a href="{% url 'ads:delete_ad' ad.id %}" class="btn btn-danger">
          Удалить
        </a>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="mt-4 border-top pt-4">
    <h4 id="questionsTitle">Вопросы по товару ({{ ad.questions.count }})</h4>
    
    {% if request.user.is_authenticated %}
      <form id="questionForm" method="POST" data-add-question-url="{% url 'ads:add_question' ad.id %}">
        {% csrf_token %} 
        <div id="questionErrors" class="alert alert-danger d-none"></div>
        <div class="mb-3">
          <textarea name="text" class="form-control" rows="3" placeholder="Задайте вопрос продавцу..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Отправить вопрос</button>
      </form>
    {% else %}
      <p class="text-muted small">Чтобы задать вопрос, <a href="{% url 'users:login' %}">войдите</a>.</p>
    {% endif %}

    <div  id="questionsList" 
          class="mt-3"
          data-initial-offset="{{ questions|length }}"
          data-has-more="{{ has_more_questions|yesno:'True,False' }}"
          data-batch-size="{{ questions_per_batch }}"
          data-load-more-url="{% url 'ads:load_more_questions' ad.id %}"
          data-trigger-type="button"
          data-load-more-btn-id="loadMoreQuestionsBtn">
      {% for question in questions %}
        {% include 'ads/includes/question_container.html' %}
      {% empty %}
        <p id="emptyMessage" class="text-muted">Вопросов пока нет. Будьте первым!</p>
      {% endfor %}
    </div>

    {% if has_more_questions %}
  <!-- Спиннер (скрыт по умолчанию) -->
    <div id="loadingSpinner" class="text-center d-none my-3">
      <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
    </div>

  <!-- Кнопка "Загрузить еще" -->
    <div class="text-center my-3">
      <button id="loadMoreQuestionsBtn" class="btn btn-outline-primary btn-sm">
        Загрузить еще вопросы
      </button>
    </div>
    {% endif %}
</div>

{% if related_ads %}
<div class="container mt-5">
    <hr>
    <h3 class="mb-4">Похожие предложения в категории "{{ ad.category.name }}"</h3>
    <div class="row">
{% comment %} with ad=item внутри тега {% include %} используется для явной передачи переменной во вложенный шаблон под конкретным именем {% endcomment %}
      {% for item in related_ads %}
        {% include 'ads/includes/ad_card.html' with ad=item %}
      {% endfor %}
    </div>
</div>
{% endif %}

{% block extra_js %}
  <script type="module" src="{% static 'js/ad_questions.js' %}"></script>
  <script type="module" src="{% static 'js/reply_manager.js' %}"></script>
{% endblock %}

{% endblock %}